name: Build WindowTabs

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4.2.2

    - name: Ensure WiX Toolset is installed
      shell: pwsh
      run: |
        if (!(choco list --local-only | Select-String wixtoolset)) {
          choco install wixtoolset -y
        } else {
          choco upgrade wixtoolset -y
        }

    - name: Setup MSBuild path
      id: find-msbuild
      shell: pwsh
      run: |
        $vs = & "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" `
          -latest -prerelease -requires Microsoft.Component.MSBuild -property installationPath
        $msbuild = Join-Path $vs 'MSBuild\Current\Bin\MSBuild.exe'
        Write-Host "MSBuild path detected: $msbuild"
        "msbuild=$msbuild" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

    - name: Build Solution (Release)
      shell: pwsh
      run: |
        Write-Host "Using MSBuild from: ${{ steps.find-msbuild.outputs.msbuild }}"
        & "${{ steps.find-msbuild.outputs.msbuild }}" WindowTabs.sln /p:Configuration=Release /m


    - name: Compile WXS â†’ WIXOBJ
      shell: pwsh
      run: |
        # 1. å…ˆæ§‹å»º WtProgramï¼Œè®“ TargetDir è£¡æœ‰æ–‡ä»¶
        & "${{ steps.find-msbuild.outputs.msbuild }}" WtProgram\WtProgram.fsproj `
          /p:Configuration=Release /t:Build

        # 2. è¨ˆç®—å‡º WtProgram çš„è¼¸å‡ºç›®éŒ„
        $programDir = Join-Path $Env:GITHUB_WORKSPACE 'WtProgram\bin\Release\'
        Write-Host "âœ” WtProgram è¼¸å‡ºç›®éŒ„ï¼š $programDir"

        # 3. ç·¨è­¯ WXS ä¸¦å®šç¾© TargetDir è®Šæ•¸
        & 'C:\Program Files (x86)\WiX Toolset v3.14\bin\candle.exe' `
          "-dWtProgram.TargetDir=$programDir" `
          -ext WixUIExtension `
          (Join-Path $Env:GITHUB_WORKSPACE 'WtSetup\WtSetup.wxs')


    - name: Debug WtProgram directory
      shell: powershell
      run: |
        Write-Host "Workspace = $Env:GITHUB_WORKSPACE"
        Write-Host "Listing WtProgram folder contents:"
        Get-ChildItem -Path (Join-Path $Env:GITHUB_WORKSPACE 'WtProgram') -Recurse | ForEach-Object {
          Write-Host "  - $($_.FullName)"
        }


    - name: Copy WiX resources into WtSetup
      shell: pwsh            # ç”¨ PowerShell 7ï¼Œæ¯” Windows PowerShell 5.1 æ›´ç©©
      run: |
        $ws     = $Env:GITHUB_WORKSPACE
        $srcDir = Join-Path $ws 'WtProgram\Resources'
        $dstDir = Join-Path $ws 'WtSetup'

        # 1. åˆ—å‡º Resources å…§çš„æª”æ¡ˆ
        Write-Host 'ğŸ” å…§å®¹ï¼ˆWtProgram\Resourcesï¼‰ï¼š'
        Get-ChildItem -Path $srcDir -Recurse |
          ForEach-Object { Write-Host ('  - ' + $_.FullName) }

        # 2. è¤‡è£½æ‰€æœ‰ .bmp èˆ‡ .ico
        Copy-Item -Path "$srcDir\*.bmp" -Destination $dstDir -Recurse -Force
        Copy-Item -Path "$srcDir\*.ico" -Destination $dstDir -Recurse -Force

        # 3. å†åˆ—ä¸€æ¬¡ WtSetupï¼Œç¢ºèªçœŸçš„è¤‡è£½éä¾†äº†
        Write-Host 'âœ” å·²è¤‡è£½åˆ° WtSetupï¼š'
        Get-ChildItem -Path $dstDir -Include *.bmp,*.ico -Recurse |
          ForEach-Object { Write-Host ('  - ' + $_.FullName) }


    - name: Link WIXOBJ â†’ MSI (auto-find)
      shell: pwsh
      run: |
        # 1. åœ¨ workspace ä¸­éè¿´åˆ—å‡ºæ‰€æœ‰ .wixobjï¼Œçœ‹çœ‹æœ‰å“ªäº›æ–‡ä»¶
        Write-Host "ğŸ” æœå°‹ .wixobj æ–‡ä»¶ï¼š"
        Get-ChildItem -Path $Env:GITHUB_WORKSPACE -Recurse -Filter *.wixobj |
          ForEach-Object { Write-Host "  - " + $_.FullName }

        # 2. å–ç¬¬ä¸€å€‹æ‰¾åˆ°çš„ .wixobj
        $wixObj = Get-ChildItem -Path $Env:GITHUB_WORKSPACE -Recurse -Filter *.wixobj |
                  Select-Object -First 1

        if (-not $wixObj) {
          Write-Error "âŒ æ‰¾ä¸åˆ°ä»»ä½• .wixobjï¼Œè«‹ç¢ºèª candle.exe æ˜¯å¦æˆåŠŸåŸ·è¡Œï¼"
          exit 1
        }

        Write-Host "âœ” ä½¿ç”¨ .wixobjï¼š $($wixObj.FullName)"

        # 3. èª¿ç”¨ light.exe ç”Ÿæˆ MSI
        $outMsi = Join-Path $Env:GITHUB_WORKSPACE 'Installer\WindowTabs.msi'
        & 'C:\Program Files (x86)\WiX Toolset v3.14\bin\light.exe' `
          -ext WixUIExtension `
          -o $outMsi `
          $wixObj.FullName

        Write-Host "âœ” å·²ç”Ÿæˆ MSIï¼š $outMsi"


    - name: Upload Artifacts
      uses: actions/upload-artifact@v4.6.2
      with:
        name: WindowTabs-Release
        path: |
          WtProgram\bin\Release\WindowTabs.exe
          Installer\WindowTabs.msi
