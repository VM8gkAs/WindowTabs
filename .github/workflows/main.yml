name: Build WindowTabs

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4.2.2

    - name: Ensure WiX Toolset is installed
      shell: powershell
      run: |
        if (!(choco list --local-only | Select-String wixtoolset)) {
          choco install wixtoolset -y
        } else {
          choco upgrade wixtoolset -y
        }

    - name: Setup MSBuild path
      id: find-msbuild
      shell: powershell
      run: |
        $vs = & "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" `
          -latest -prerelease -requires Microsoft.Component.MSBuild -property installationPath
        $msbuild = Join-Path $vs 'MSBuild\Current\Bin\MSBuild.exe'
        Write-Host "MSBuild path detected: $msbuild"
        "msbuild=$msbuild" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append

    - name: Build Solution (Release)
      shell: powershell
      run: |
        Write-Host "Using MSBuild from: ${{ steps.find-msbuild.outputs.msbuild }}"
        & "${{ steps.find-msbuild.outputs.msbuild }}" WindowTabs.sln /p:Configuration=Release /m

    - name: Compile WXS → WIXOBJ
      shell: pwsh
      run: |
        # 遞迴搜尋 repo 中第一個 Product.wxs
        $wxsFile = Get-ChildItem -Path $Env:GITHUB_WORKSPACE -Filter Product.wxs -Recurse |
                   Select-Object -First 1

        # 找不到就讓工作流失敗
        if (-not $wxsFile) { Write-Error '❌ 找不到 Product.wxs'; exit 1 }

        Write-Host "✔ Found Product.wxs at: $($wxsFile.FullName)"

        # 呼叫 candle.exe 進行編譯
        & 'C:\Program Files (x86)\WiX Toolset v3.14\bin\candle.exe' `
          $wxsFile.FullName `
          -ext WixUIExtension

    - name: Link WIXOBJ → MSI
      shell: pwsh
      run: |
        # 1. 在 repo 根目錄遞迴搜尋 Product.wixobj
        $wxsFile = Get-ChildItem -Path $Env:GITHUB_WORKSPACE -Filter Product.wixobj -Recurse |
                   Select-Object -First 1

        if (-not $wxsFile) { Write-Error '❌ 找不到 Product.wixobj'; exit 1 }

        Write-Host "✔ Found Product.wixobj at: $($wixobjFile.FullName)"
        & 'C:\Program Files (x86)\WiX Toolset v3.14\bin\light.exe' `
          -ext WixUIExtension `
          -o '.\Installer\WindowTabs.msi' `
          $wxsFile.FullName

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4.6.2
      with:
        name: WindowTabs-Release
        path: |
          WtProgram\bin\Release\WindowTabs.exe
          Installer\WindowTabs.msi
